<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scuba Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            overflow: hidden;
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 40px;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        }

        .dashboard-header {
            margin-bottom: 48px;
        }

        .dashboard-title {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .dashboard-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.5);
        }

        .dashboard-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        .btn-new-project {
            padding: 16px 32px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-new-project:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.4);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            overflow-y: auto;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .project-card:hover {
            border-color: #00d4ff;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.2);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .project-name {
            font-size: 20px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .project-delete {
            background: rgba(255, 68, 68, 0.1);
            border: none;
            color: #ff4444;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .project-meta {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Builder */
        .builder-container {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%);
            border-bottom: 2px solid #00d4ff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .project-name-input {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            width: 200px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Sidebar Left */
        .sidebar-left {
            background: #151830;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-tab {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .sidebar-tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Pages Tab */
        .pages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .pages-title {
            font-size: 14px;
            font-weight: 700;
            color: #00d4ff;
        }

        .btn-add-page {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .page-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .page-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }

        .page-item.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .page-name {
            font-size: 14px;
            color: #e0e0e0;
        }

        .page-delete {
            background: transparent;
            border: none;
            color: rgba(255, 68, 68, 0.7);
            cursor: pointer;
            font-size: 16px;
        }

        /* Assets Tab */
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .btn-sync-components {
            background: rgba(123, 44, 191, 0.2);
            border: 1px solid rgba(123, 44, 191, 0.4);
            color: #b57edc;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sync-components:hover {
            background: rgba(123, 44, 191, 0.3);
        }

        .sync-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(181, 126, 220, 0.3);
            border-top-color: #b57edc;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .component-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
        }

        .component-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.3s ease;
        }

        .component-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            transform: translateX(4px);
        }

        .component-name {
            font-size: 13px;
            font-weight: 600;
            color: #e0e0e0;
        }

        /* Canvas */
        .canvas-area {
            background: #0d1117;
            position: relative;
            overflow: auto;
        }

        .canvas-toolbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(21, 24, 48, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .toolbar-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 12px;
        }

        .canvas-content {
            padding: 80px 40px 40px;
            min-height: 100%;
        }

        .canvas-drop-zone {
            min-height: 600px;
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 40px;
        }

        .canvas-drop-zone.drag-over {
            background: rgba(0, 212, 255, 0.05);
            border-color: #00d4ff;
        }

        .canvas-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.3);
            padding: 60px 20px;
        }

        /* Layout Components */
        .layout-container {
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            min-height: 100px;
            position: relative;
        }

        .layout-container.flex-container {
            display: flex;
        }

        .layout-container.grid-container {
            display: grid;
        }

        .layout-container.selected {
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .layout-container.drag-over {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }

        .layout-label {
            position: absolute;
            top: -10px;
            left: 12px;
            background: #0d1117;
            padding: 2px 8px;
            font-size: 11px;
            color: #00d4ff;
            border-radius: 4px;
        }

        .layout-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.3);
            padding: 20px;
            font-size: 12px;
        }

        /* Dropped Component */
        .dropped-component {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .dropped-component.selected {
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .component-controls {
            position: absolute;
            top: -12px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dropped-component:hover .component-controls,
        .layout-container:hover > .component-controls {
            opacity: 1;
        }

        .component-control-btn {
            width: 24px;
            height: 24px;
            background: #00d4ff;
            border: none;
            border-radius: 4px;
            color: #000;
            cursor: pointer;
            font-size: 11px;
        }

        /* Properties Panel */
        .sidebar-right {
            background: #151830;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px;
        }

        .properties-title {
            font-size: 14px;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 20px;
        }

        .property-section {
            margin-bottom: 24px;
        }

        .property-section-title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .property-field {
            margin-bottom: 16px;
        }

        .property-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
            display: block;
        }

        .property-input,
        .property-select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .property-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .property-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .property-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }

        .property-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .property-checkbox input {
            width: 16px;
            height: 16px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <div class="dashboard-title">SCUBA Builder</div>
            <div class="dashboard-subtitle">Crie interfaces incr√≠veis com componentes Scuba</div>
        </div>
        <div class="dashboard-actions">
            <button class="btn-new-project" onclick="createNewProject()">
                ‚ûï Novo Projeto
            </button>
        </div>
        <div class="projects-grid" id="projectsGrid">
            <!-- Projects will be rendered here -->
        </div>
    </div>

    <!-- Builder -->
    <div class="builder-container hidden" id="builder">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo" onclick="backToDashboard()">‚Üê SCUBA</div>
                <input type="text" class="project-name-input" id="projectNameInput" placeholder="Nome do projeto">
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportProject()">‚¨áÔ∏è Exportar</button>
                <button class="btn btn-primary" onclick="saveProject()">üíæ Salvar</button>
            </div>
        </div>

        <!-- Sidebar Left -->
        <div class="sidebar-left">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('pages')">üìÑ Pages</button>
                <button class="sidebar-tab" onclick="switchTab('assets')">üé® Assets</button>
            </div>
            <div class="sidebar-content">
                <!-- Pages Tab -->
                <div class="tab-pane active" id="pagesTab">
                    <div class="pages-header">
                        <div class="pages-title">P√°ginas</div>
                        <button class="btn-add-page" onclick="addNewPage()">+ Nova</button>
                    </div>
                    <div id="pagesList">
                        <!-- Pages will be rendered here -->
                    </div>
                </div>

                <!-- Assets Tab -->
                <div class="tab-pane" id="assetsTab">
                    <div class="assets-header">
                        <div class="pages-title">Componentes</div>
                        <button class="btn-sync-components" onclick="syncComponents()">
                            <span class="sync-icon">üîÑ</span>
                            <span>Sincronizar</span>
                        </button>
                    </div>
                    <div id="componentsList">
                        <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                            <div style="font-size: 32px; margin-bottom: 12px;">üì¶</div>
                            <div>Clique em Sincronizar para carregar os componentes do Scuba</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas-area">
            <div class="canvas-toolbar">
                <button class="toolbar-btn" onclick="setViewMode('desktop')">üñ•Ô∏è Desktop</button>
                <button class="toolbar-btn" onclick="setViewMode('tablet')">üì± Tablet</button>
                <button class="toolbar-btn" onclick="setViewMode('mobile')">üì± Mobile</button>
            </div>
            <div class="canvas-content">
                <div class="canvas-drop-zone" id="canvas">
                    <div class="canvas-placeholder">
                        <div style="font-size: 64px; margin-bottom: 16px;">üìê</div>
                        <div>Comece adicionando um Container ou Grid</div>
                        <div style="margin-top: 8px; font-size: 12px;">Arraste componentes de layout da aba Assets</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Right -->
        <div class="sidebar-right" id="propertiesPanel">
            <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.3);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                <div>Selecione um componente<br>para editar propriedades</div>
            </div>
        </div>
    </div>

    <script>
        const STORYBOOK_URL = 'https://atramontdeep.github.io/scuba-dev';
        
        // Estado global
        let currentProject = null;
        let currentPageId = null;
        let selectedComponentId = null;
        let scubaComponents = null;

        // Layout components built-in
        const layoutComponents = {
            layout: [
                {
                    id: 'flex-container',
                    name: 'Container (Flex)',
                    description: 'Container flex√≠vel para layouts',
                    isLayout: true,
                    props: {
                        direction: {
                            type: 'select',
                            options: ['row', 'column', 'row-reverse', 'column-reverse'],
                            default: 'row',
                            label: 'Dire√ß√£o'
                        },
                        justify: {
                            type: 'select',
                            options: ['flex-start', 'center', 'flex-end', 'space-between', 'space-around', 'space-evenly'],
                            default: 'flex-start',
                            label: 'Justify Content'
                        },
                        align: {
                            type: 'select',
                            options: ['flex-start', 'center', 'flex-end', 'stretch', 'baseline'],
                            default: 'flex-start',
                            label: 'Align Items'
                        },
                        gap: {
                            type: 'number',
                            default: 16,
                            label: 'Gap (px)'
                        },
                        padding: {
                            type: 'number',
                            default: 20,
                            label: 'Padding (px)'
                        },
                        wrap: {
                            type: 'select',
                            options: ['nowrap', 'wrap', 'wrap-reverse'],
                            default: 'nowrap',
                            label: 'Flex Wrap'
                        }
                    }
                },
                {
                    id: 'grid-container',
                    name: 'Grid',
                    description: 'Container em grid',
                    isLayout: true,
                    props: {
                        columns: {
                            type: 'number',
                            default: 3,
                            label: 'Colunas'
                        },
                        rows: {
                            type: 'number',
                            default: 0,
                            label: 'Linhas (auto se 0)'
                        },
                        gap: {
                            type: 'number',
                            default: 24,
                            label: 'Gap (px)'
                        },
                        columnGap: {
                            type: 'number',
                            default: 0,
                            label: 'Column Gap (0 = usar gap)'
                        },
                        rowGap: {
                            type: 'number',
                            default: 0,
                            label: 'Row Gap (0 = usar gap)'
                        },
                        padding: {
                            type: 'number',
                            default: 20,
                            label: 'Padding (px)'
                        }
                    }
                }
            ]
        };

        // Initialize
        window.onload = function() {
            loadDashboard();
        };

        // Dashboard functions
        function loadDashboard() {
            const projects = JSON.parse(localStorage.getItem('scubaProjects') || '[]');
            const grid = document.getElementById('projectsGrid');
            
            if (projects.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 64px; margin-bottom: 16px;">üìÇ</div>
                        <div style="font-size: 18px;">Nenhum projeto ainda</div>
                        <div style="margin-top: 8px;">Clique em "Novo Projeto" para come√ßar</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = projects.map(project => `
                <div class="project-card" onclick="openProject('${project.id}')">
                    <div class="project-card-header">
                        <div class="project-name">${project.name}</div>
                        <button class="project-delete" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="project-meta">
                        ${project.pages.length} p√°gina(s) ¬∑ Atualizado ${new Date(project.updatedAt).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function createNewProject() {
            const name = prompt('Nome do projeto:');
            if (!name) return;

            const project = {
                id: 'project_' + Date.now(),
                name: name,
                pages: [{
                    id: 'page_' + Date.now(),
                    name: 'Home',
                    components: []
                }],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const projects = JSON.parse(localStorage.getItem('scubaProjects') || '[]');
            projects.push(project);
            localStorage.setItem('scubaProjects', JSON.stringify(projects));

            openProject(project.id);
        }

        function openProject(projectId) {
            const projects = JSON.parse(localStorage.getItem('scubaProjects') || '[]');
            currentProject = projects.find(p => p.id === projectId);
            
            if (!currentProject) return;

            currentPageId = currentProject.pages[0].id;
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('builder').classList.remove('hidden');
            document.getElementById('projectNameInput').value = currentProject.name;

            renderPages();
            renderCanvas();
        }

        function backToDashboard() {
            if (currentProject) {
                saveProject();
            }
            document.getElementById('builder').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboard();
        }

        function deleteProject(projectId) {
            if (!confirm('Tem certeza que deseja deletar este projeto?')) return;

            const projects = JSON.parse(localStorage.getItem('scubaProjects') || '[]');
            const filtered = projects.filter(p => p.id !== projectId);
            localStorage.setItem('scubaProjects', JSON.stringify(filtered));
            loadDashboard();
        }

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Pages
        function renderPages() {
            const list = document.getElementById('pagesList');
            list.innerHTML = currentProject.pages.map(page => `
                <div class="page-item ${page.id === currentPageId ? 'active' : ''}" onclick="selectPage('${page.id}')">
                    <span class="page-name">${page.name}</span>
                    ${currentProject.pages.length > 1 ? `
                        <button class="page-delete" onclick="event.stopPropagation(); deletePage('${page.id}')">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function addNewPage() {
            const name = prompt('Nome da p√°gina:');
            if (!name) return;

            const newPage = {
                id: 'page_' + Date.now(),
                name: name,
                components: []
            };

            currentProject.pages.push(newPage);
            currentPageId = newPage.id;
            renderPages();
            renderCanvas();
        }

        function selectPage(pageId) {
            currentPageId = pageId;
            selectedComponentId = null;
            renderPages();
            renderCanvas();
            renderPropertiesPanel();
        }

        function deletePage(pageId) {
            if (!confirm('Deletar esta p√°gina?')) return;

            currentProject.pages = currentProject.pages.filter(p => p.id !== pageId);
            if (currentPageId === pageId) {
                currentPageId = currentProject.pages[0].id;
            }
            renderPages();
            renderCanvas();
        }

        // Components sync
        async function syncComponents() {
            const btn = event.target.closest('.btn-sync-components');
            const icon = btn.querySelector('.sync-icon');
            icon.innerHTML = '<span class="sync-spinner"></span>';
            
            try {
                // Tentar buscar stories.json ou index.json do Storybook
                const response = await fetch(`${STORYBOOK_URL}/stories.json`).catch(() => 
                    fetch(`${STORYBOOK_URL}/index.json`)
                );
                
                if (response.ok) {
                    const data = await response.json();
                    scubaComponents = parseStorybookData(data);
                } else {
                    // Fallback: usar componentes mockados
                    scubaComponents = getMockComponents();
                }
                
                localStorage.setItem('scubaComponents', JSON.stringify(scubaComponents));
                renderComponentsList();
                
            } catch (error) {
                console.error('Erro ao sincronizar:', error);
                scubaComponents = getMockComponents();
                renderComponentsList();
            }
            
            icon.innerHTML = '‚úì';
            setTimeout(() => icon.innerHTML = 'üîÑ', 1500);
        }

        function parseStorybookData(data) {
            // Parse Storybook data structure
            const components = {};
            
            if (data.stories) {
                Object.values(data.stories).forEach(story => {
                    const category = story.kind?.split('/')[0]?.toLowerCase() || 'other';
                    const name = story.name || story.id;
                    
                    if (!components[category]) {
                        components[category] = [];
                    }
                    
                    components[category].push({
                        id: story.id,
                        name: name,
                        description: story.parameters?.docs?.description || '',
                        storyPath: story.id,
                        props: extractPropsFromStory(story)
                    });
                });
            }
            
            return components;
        }

        function extractPropsFromStory(story) {
            const props = {};
            
            if (story.argTypes) {
                Object.entries(story.argTypes).forEach(([key, config]) => {
                    props[key] = {
                        type: config.control?.type || 'text',
                        options: config.options || [],
                        default: config.defaultValue || '',
                        label: config.name || key
                    };
                });
            }
            
            return props;
        }

        function getMockComponents() {
            return {
                buttons: [
                    {
                        id: 'button',
                        name: 'Button',
                        description: 'Bot√£o do Scuba',
                        props: {
                            children: { type: 'text', default: 'Button', label: 'Texto' },
                            variant: { 
                                type: 'select', 
                                options: ['primary', 'secondary', 'outline'], 
                                default: 'primary',
                                label: 'Variante'
                            }
                        }
                    }
                ],
                inputs: [
                    {
                        id: 'input',
                        name: 'Input',
                        description: 'Campo de entrada',
                        props: {
                            placeholder: { type: 'text', default: 'Digite...', label: 'Placeholder' },
                            label: { type: 'text', default: 'Label', label: 'Label' }
                        }
                    }
                ]
            };
        }

        function renderComponentsList() {
            const list = document.getElementById('componentsList');
            const allComponents = { ...layoutComponents, ...scubaComponents };
            
            list.innerHTML = Object.entries(allComponents).map(([category, components]) => `
                <div class="component-category">
                    <div class="category-title">${category.toUpperCase()}</div>
                    ${components.map(comp => `
                        <div class="component-item" draggable="true" 
                             ondragstart="handleDragStart(event, '${category}', '${comp.id}')">
                            <div class="component-name">${comp.name}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Drag and drop
        function handleDragStart(event, category, componentId) {
            event.dataTransfer.setData('category', category);
            event.dataTransfer.setData('componentId', componentId);
        }

        // Canvas
        const canvas = document.getElementById('canvas');

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target.closest('.layout-container');
            if (target) {
                target.classList.add('drag-over');
            } else {
                canvas.classList.add('drag-over');
            }
        });

        canvas.addEventListener('dragleave', (e) => {
            const target = e.target.closest('.layout-container');
            if (target) {
                target.classList.remove('drag-over');
            } else {
                canvas.classList.remove('drag-over');
            }
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            canvas.classList.remove('drag-over');
            
            const category = e.dataTransfer.getData('category');
            const componentId = e.dataTransfer.getData('componentId');
            
            const layoutTarget = e.target.closest('.layout-container');
            const parentId = layoutTarget?.dataset.componentId || null;
            
            if (layoutTarget) {
                layoutTarget.classList.remove('drag-over');
            }
            
            addComponent(category, componentId, parentId);
        });

        function addComponent(category, componentId, parentId = null) {
            const allComponents = { ...layoutComponents, ...scubaComponents };
            const component = allComponents[category]?.find(c => c.id === componentId);
            if (!component) return;

            const instance = {
                id: 'comp_' + Date.now(),
                componentId: component.id,
                category: category,
                isLayout: component.isLayout || false,
                parentId: parentId,
                children: [],
                props: {}
            };

            // Initialize props
            if (component.props) {
                Object.entries(component.props).forEach(([key, config]) => {
                    instance.props[key] = config.default;
                });
            }

            const currentPage = getCurrentPage();
            
            if (parentId) {
                const parent = findComponentById(currentPage.components, parentId);
                if (parent) {
                    parent.children.push(instance);
                }
            } else {
                currentPage.components.push(instance);
            }

            renderCanvas();
            
            const placeholder = canvas.querySelector('.canvas-placeholder');
            if (placeholder) placeholder.style.display = 'none';
        }

        function getCurrentPage() {
            return currentProject.pages.find(p => p.id === currentPageId);
        }

        function findComponentById(components, id) {
            for (const comp of components) {
                if (comp.id === id) return comp;
                if (comp.children) {
                    const found = findComponentById(comp.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function renderCanvas() {
            const currentPage = getCurrentPage();
            const existingComponents = canvas.querySelectorAll('.layout-container, .dropped-component');
            existingComponents.forEach(el => el.remove());

            if (currentPage.components.length === 0) {
                const placeholder = canvas.querySelector('.canvas-placeholder');
                if (placeholder) placeholder.style.display = 'block';
                return;
            }

            currentPage.components.forEach(instance => {
                const element = renderComponent(instance);
                canvas.appendChild(element);
            });
        }

        function renderComponent(instance) {
            const allComponents = { ...layoutComponents, ...scubaComponents };
            const component = allComponents[instance.category]?.find(c => c.id === instance.componentId);
            
            if (!component) return document.createElement('div');

            if (instance.isLayout) {
                return renderLayoutComponent(instance, component);
            } else {
                return renderRegularComponent(instance, component);
            }
        }

        function renderLayoutComponent(instance, component) {
            const div = document.createElement('div');
            div.className = `layout-container ${instance.componentId === 'flex-container' ? 'flex-container' : 'grid-container'}`;
            div.dataset.componentId = instance.id;
            
            if (selectedComponentId === instance.id) {
                div.classList.add('selected');
            }

            // Apply styles
            if (instance.componentId === 'flex-container') {
                div.style.flexDirection = instance.props.direction;
                div.style.justifyContent = instance.props.justify;
                div.style.alignItems = instance.props.align;
                div.style.gap = instance.props.gap + 'px';
                div.style.padding = instance.props.padding + 'px';
                div.style.flexWrap = instance.props.wrap;
            } else {
                div.style.gridTemplateColumns = `repeat(${instance.props.columns}, 1fr)`;
                if (instance.props.rows > 0) {
                    div.style.gridTemplateRows = `repeat(${instance.props.rows}, 1fr)`;
                }
                const colGap = instance.props.columnGap || instance.props.gap;
                const rowGap = instance.props.rowGap || instance.props.gap;
                div.style.gap = `${rowGap}px ${colGap}px`;
                div.style.padding = instance.props.padding + 'px';
            }

            div.innerHTML = `
                <div class="component-controls">
                    <button class="component-control-btn" onclick="deleteComponent('${instance.id}')">üóëÔ∏è</button>
                </div>
                <div class="layout-label">${component.name}</div>
            `;

            // Render children
            if (instance.children && instance.children.length > 0) {
                instance.children.forEach(child => {
                    const childElement = renderComponent(child);
                    div.appendChild(childElement);
                });
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'layout-placeholder';
                placeholder.textContent = 'Arraste componentes aqui';
                div.appendChild(placeholder);
            }

            div.addEventListener('click', (e) => {
                if (e.target === div || e.target.classList.contains('layout-label')) {
                    selectComponent(instance.id);
                }
            });

            // Drag over for nested drops
            div.addEventListener('dragover', (e) => {
                e.stopPropagation();
                e.preventDefault();
                div.classList.add('drag-over');
            });

            div.addEventListener('dragleave', () => {
                div.classList.remove('drag-over');
            });

            return div;
        }

        function renderRegularComponent(instance, component) {
            const div = document.createElement('div');
            div.className = 'dropped-component';
            div.dataset.componentId = instance.id;
            
            if (selectedComponentId === instance.id) {
                div.classList.add('selected');
            }

            div.innerHTML = `
                <div class="component-controls">
                    <button class="component-control-btn" onclick="deleteComponent('${instance.id}')">üóëÔ∏è</button>
                </div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">
                    ${component.name}
                </div>
                <div style="padding: 12px; background: rgba(0,212,255,0.1); border-radius: 4px; color: #e0e0e0;">
                    [${component.name} Component Preview]
                </div>
            `;

            div.addEventListener('click', () => selectComponent(instance.id));

            return div;
        }

        function selectComponent(componentId) {
            selectedComponentId = componentId;
            renderCanvas();
            renderPropertiesPanel();
        }

        function deleteComponent(componentId) {
            const currentPage = getCurrentPage();
            
            function removeFromArray(arr) {
                for (let i = 0; i < arr.length; i++) {
                    if (arr[i].id === componentId) {
                        arr.splice(i, 1);
                        return true;
                    }
                    if (arr[i].children && removeFromArray(arr[i].children)) {
                        return true;
                    }
                }
                return false;
            }

            removeFromArray(currentPage.components);
            selectedComponentId = null;
            renderCanvas();
            renderPropertiesPanel();
        }

        // Properties panel
        function renderPropertiesPanel() {
            const panel = document.getElementById('propertiesPanel');
            
            if (!selectedComponentId) {
                panel.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.3);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚öôÔ∏è</div>
                        <div>Selecione um componente</div>
                    </div>
                `;
                return;
            }

            const currentPage = getCurrentPage();
            const instance = findComponentById(currentPage.components, selectedComponentId);
            if (!instance) return;

            const allComponents = { ...layoutComponents, ...scubaComponents };
            const component = allComponents[instance.category]?.find(c => c.id === instance.componentId);
            if (!component) return;

            panel.innerHTML = `
                <div class="properties-title">${component.name}</div>
                ${renderPropertiesFields(instance, component)}
            `;

            // Add event listeners
            Object.keys(component.props || {}).forEach(key => {
                const input = panel.querySelector(`[data-prop="${key}"]`);
                if (input) {
                    input.addEventListener('change', (e) => {
                        const value = e.target.type === 'checkbox' ? e.target.checked : 
                                     e.target.type === 'number' ? parseInt(e.target.value) :
                                     e.target.value;
                        instance.props[key] = value;
                        renderCanvas();
                    });
                }
            });
        }

        function renderPropertiesFields(instance, component) {
            if (!component.props) return '';

            const sections = instance.isLayout ? 
                { 'Layout': component.props } : 
                { 'Propriedades': component.props };

            return Object.entries(sections).map(([sectionName, props]) => `
                <div class="property-section">
                    <div class="property-section-title">${sectionName}</div>
                    ${Object.entries(props).map(([key, config]) => {
                        return renderPropertyField(key, config, instance.props[key]);
                    }).join('')}
                </div>
            `).join('');
        }

        function renderPropertyField(key, config, value) {
            if (config.type === 'select') {
                return `
                    <div class="property-field">
                        <label class="property-label">${config.label}</label>
                        <select class="property-select" data-prop="${key}">
                            ${config.options.map(opt => `
                                <option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (config.type === 'boolean') {
                return `
                    <div class="property-field">
                        <div class="property-checkbox">
                            <input type="checkbox" data-prop="${key}" ${value ? 'checked' : ''}>
                            <label class="property-label">${config.label}</label>
                        </div>
                    </div>
                `;
            } else if (config.type === 'number') {
                return `
                    <div class="property-field">
                        <label class="property-label">${config.label}</label>
                        <input type="number" class="property-input" data-prop="${key}" value="${value}">
                    </div>
                `;
            } else {
                return `
                    <div class="property-field">
                        <label class="property-label">${config.label}</label>
                        <input type="text" class="property-input" data-prop="${key}" value="${value}">
                    </div>
                `;
            }
        }

        // Save/Export
        function saveProject() {
            if (!currentProject) return;

            currentProject.name = document.getElementById('projectNameInput').value;
            currentProject.updatedAt = new Date().toISOString();

            const projects = JSON.parse(localStorage.getItem('scubaProjects') || '[]');
            const index = projects.findIndex(p => p.id === currentProject.id);
            
            if (index >= 0) {
                projects[index] = currentProject;
            } else {
                projects.push(currentProject);
            }

            localStorage.setItem('scubaProjects', JSON.stringify(projects));
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Salvo';
            setTimeout(() => btn.textContent = originalText, 1500);
        }

        function exportProject() {
            if (!currentProject) return;

            const blob = new Blob([JSON.stringify(currentProject, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}.scuba.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // View modes
        function setViewMode(mode) {
            const canvas = document.querySelector('.canvas-drop-zone');
            switch(mode) {
                case 'desktop':
                    canvas.style.maxWidth = '100%';
                    canvas.style.margin = '0';
                    break;
                case 'tablet':
                    canvas.style.maxWidth = '768px';
                    canvas.style.margin = '0 auto';
                    break;
                case 'mobile':
                    canvas.style.maxWidth = '375px';
                    canvas.style.margin = '0 auto';
                    break;
            }
        }
    </script>
</body>
</html>
